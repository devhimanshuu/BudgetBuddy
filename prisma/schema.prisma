// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}


model UserSettings{
  userId   String @id
  currency String
  
  // Gamification fields
  currentStreak Int @default(0)
  longestStreak Int @default(0)
  lastActivityDate DateTime?
  totalPoints Int @default(0)

  // ALERT & NOTIFICATION SETTINGS
  spendingLimitThreshold Int     @default(80) // % of budget reached
  enableAnomalyDetection Boolean @default(true)
  anomalyThreshold       Float   @default(2.0) // Multiplier of average (e.g., 2x)
  activeTheme            String  @default("default") // "default", "midnight", "gold"
}

model Category {
  createdAt DateTime @default(now())
  name      String 
  userId    String 
  icon      String 
  type      String  @default("income")

  @@unique([name, userId, type])
}

model Transaction {
  id String @id @default(uuid())
  createdAt DateTime @default(now())
  updateAt DateTime @default(now())

  amount Float 
  description String 
  notes String? // Optional notes field
  date DateTime
  userId String
  type String  @default("income")

  category String 
  categoryIcon String 
  
  tags TransactionTag[]
  attachments Attachment[]
  splits TransactionSplit[]
  history TransactionHistory[]
  
  @@index([userId, date])
  @@index([userId, category])
  @@index([userId, type, date]) // Optimize "Get all expenses for month"
  @@index([userId, date, type]) // Optimize date range + type filtering
}

model Tag {
  id String @id @default(uuid())
  name String
  color String @default("#3b82f6") // Default blue color
  userId String
  createdAt DateTime @default(now())
  
  transactions TransactionTag[]
  
  @@unique([name, userId])
  @@index([userId])
}

model TransactionTag {
  transactionId String
  tagId String
  
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  tag Tag @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@id([transactionId, tagId])
}

model Attachment {
  id String @id @default(uuid())
  transactionId String
  fileName String
  fileUrl String
  fileSize Int
  fileType String
  uploadedAt DateTime @default(now())
  
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  @@index([transactionId])
}

model MonthlyHistory {
  userId String
  day Int 
  month Int 
  year Int 
  income Float
  expense Float

  @@id([day, month, year, userId])
  @@index([userId, month, year]) // Optimize stats/dashboard queries
}

model YearHistory {
  userId String
  month Int 
  year Int 
  income Float
  expense Float

  @@id([month, year, userId])
}

model Budget {
  id String @id @default(uuid())
  userId String
  category String
  categoryIcon String
  amount Float
  month Int
  year Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, category, month, year])
  @@index([userId, month, year])
}

model SavingsGoal {
  id String @id @default(uuid())
  userId String
  name String
  description String?
  targetAmount Float
  currentAmount Float @default(0)
  targetDate DateTime
  category String @default("General")
  icon String @default("ðŸŽ¯")
  color String @default("#3b82f6")
  isCompleted Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, isCompleted])
}

model TransactionSplit {
  id String @id @default(uuid())
  transactionId String
  category String
  categoryIcon String
  amount Float
  percentage Float
  
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  

  
  @@index([transactionId])
}

model TransactionHistory {
  id            String   @id @default(uuid())
  transactionId String
  amount        Float
  description   String
  notes         String?
  date          DateTime
  category      String
  categoryIcon  String
  type          String
  tags          String[] // Storing tag IDs as array of strings
  changedAt     DateTime @default(now())

  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([transactionId])
}

model Asset {
  id String @id @default(uuid())
  userId String
  name String
  description String?
  type String // "asset" or "liability"
  category String // "stocks", "real-estate", "crypto", "cash", "mortgage", "loan", "credit-card", "other"
  currentValue Float
  icon String @default("ðŸ’°")
  color String @default("#3b82f6")
  notes String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  history AssetHistory[]
  
  @@index([userId])
  @@index([userId, type])
  @@index([userId, category])
}

model AssetHistory {
  id String @id @default(uuid())
  assetId String
  value Float
  date DateTime
  notes String?
  createdAt DateTime @default(now())
  
  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  @@index([assetId])
  @@index([assetId, date])
}

model RecurringTransaction {
  id String @id @default(uuid())
  userId String
  amount Float
  description String
  type String @default("income") // "income" or "expense"
  
  category String
  categoryIcon String
  
  date DateTime // Next due date
  interval String // "daily", "weekly", "monthly", "yearly"
  
  lastProcessed DateTime? 
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Achievement {
  id String @id @default(uuid())
  key String @unique // e.g., "first_transaction", "streak_7", "budget_hero"
  name String
  description String
  icon String
  category String // "streak", "budget", "savings", "general"
  tier String @default("bronze") // "bronze", "silver", "gold", "platinum"
  points Int @default(10)
  requirement Int? // e.g., 7 for "7 day streak"
  createdAt DateTime @default(now())
  
  userAchievements UserAchievement[]
}

model UserAchievement {
  id String @id @default(uuid())
  userId String
  achievementId String
  unlockedAt DateTime @default(now())
  progress Int @default(0) // For tracking progress towards achievement
  
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  
  @@unique([userId, achievementId])
  @@index([userId])
  @@index([userId, unlockedAt])
}
